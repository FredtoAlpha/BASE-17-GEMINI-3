<!DOCTYPE html>
<html lang="fr">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>CONSOLE EXPERT V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1; --bg-dark: #0f172a; --text-white: #f8fafc;
            --success: #22c55e; --warning: #eab308;
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-white);
            margin: 0; height: 100vh; overflow: hidden;
            display: grid; grid-template-columns: 320px 1fr;
        }

        /* TYPOGRAPHIE XXL */
        h1 { font-size: 32px; font-weight: 900; margin-bottom: 20px; letter-spacing: -1px; }
        h2 { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 15px; text-transform: uppercase; }

        label { font-size: 14px; font-weight: 800; color: #94a3b8; margin-bottom: 8px; display: block; text-transform: uppercase; }

        input, select {
            width: 100%; padding: 16px; font-size: 16px; font-weight: 700;
            background: #1e293b; border: 2px solid #334155; color: white; border-radius: 8px;
            margin-bottom: 20px; box-sizing: border-box;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        .btn {
            width: 100%; padding: 20px; font-size: 18px; font-weight: 900;
            text-transform: uppercase; border: none; border-radius: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: #022c22; }
        .btn-secondary { background: #334155; color: white; }

        /* SIDEBAR */
        .sidebar { background: #020617; padding: 30px; border-right: 1px solid #1e293b; overflow-y: auto; }
        .brand { font-size: 26px; font-weight: 900; margin-bottom: 50px; display: flex; gap: 15px; align-items: center; }

        .nav-item {
            padding: 18px; margin-bottom: 10px; border-radius: 10px; cursor: pointer;
            font-size: 16px; font-weight: 700; color: #94a3b8; display: flex; gap: 15px;
            transition: 0.2s;
        }
        .nav-item:hover { background: rgba(99, 102, 241, 0.1); }
        .nav-item.active { background: var(--primary); color: white; }

        /* CONTENT */
        .main-content { padding: 50px; overflow-y: auto; }
        .card { background: #1e293b; padding: 40px; border-radius: 20px; border: 1px solid #334155; }
        .phase { display: none; }
        .phase.active { display: block; animation: fadeIn 0.3s; }

        .alert { background: rgba(99, 102, 241, 0.1); padding: 20px; border-left: 5px solid var(--primary); font-weight: 600; margin: 20px 0; border-radius: 5px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><i class="fas fa-rocket"></i> PILOTE V3</div>
        <nav>
            <div class="nav-item active" onclick="goToPhase(1)" id="nav-1">
                <span>1. ARCHITECTURE</span>
            </div>
            <div class="nav-item" onclick="goToPhase(2)" id="nav-2">
                <span>2. DONN√âES</span>
            </div>
            <div class="nav-item" onclick="goToPhase(3)" id="nav-3">
                <span>3. STRAT√âGIE</span>
            </div>
            <div class="nav-item" onclick="goToPhase(4)" id="nav-4">
                <span>4. MOTEUR</span>
            </div>
            <div class="nav-item" onclick="goToPhase(5)" id="nav-5">
                <span>5. PILOTAGE</span>
            </div>
        </nav>
    </aside>

    <main class="main-content">

        <div id="phase-1" class="phase active">
            <h1>INITIALISATION & PARAM√âTRAGE</h1>
            <div class="card">
                <h2>1. Architecture</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label>üîí Mot de Passe Admin</label>
                        <input type="password" id="config-pwd" value="admin123">
                    </div>
                    <div>
                        <label>üéì Niveau Scolaire</label>
                        <select id="config-level">
                            <optgroup label="√âcole Primaire">
                                <option value="CM2">CM2</option>
                            </optgroup>
                            <optgroup label="Coll√®ge" selected>
                                <option value="6¬∞">6√®me</option>
                                <option value="5¬∞" selected>5√®me</option>
                                <option value="4¬∞">4√®me</option>
                                <option value="3¬∞">3√®me</option>
                            </optgroup>
                            <optgroup label="Lyc√©e">
                                <option value="2nde">2nde</option>
                                <option value="1√®re">1√®re</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label>üìÇ Nb Classes Sources</label>
                        <input type="number" id="config-nb-src" value="6" min="1" max="30">
                    </div>
                    <div>
                        <label>üéØ Nb Classes Cibles</label>
                        <input type="number" id="config-nb-dest" value="6" min="1" max="20">
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px solid #334155; margin: 20px 0;">

                <h2>2. Dictionnaire des Codes (Pas de code en dur !)</h2>
                <p style="font-size: 13px; color: #94a3b8; margin-bottom: 15px;">
                    Saisissez les codes s√©par√©s par des virgules. Ces listes serviront aux menus d√©roulants des onglets.
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div>
                        <label>üåç Langues (LV1/LV2)</label>
                        <input type="text" id="config-lv2" placeholder="Ex: ANG, ALL, ESP, ITA" value="ANG, ALL, ESP, ITA">
                    </div>
                    <div>
                        <label>üöÄ Options</label>
                        <input type="text" id="config-opt" placeholder="Ex: LATIN, GREC, CHAV, SPORT" value="LATIN, CHAV">
                    </div>
                    <div>
                        <label>üìã Dispositifs (Col L)</label>
                        <input type="text" id="config-dispo" placeholder="Ex: PAI, PPRE, ULIS, SEGPA" value="PAI, PPRE, PAP, ULIS, UPE2A">
                    </div>
                </div>

                <div class="alert">
                    <i class="fas fa-info-circle"></i>
                    Ces param√®tres seront enregistr√©s dans l'onglet <strong>_CONFIG</strong>. Vous pourrez les modifier plus tard.
                </div>

                <button onclick="runInit()" class="btn btn-primary">
                    <i class="fas fa-hammer"></i> LANCER LA CONSTRUCTION
                </button>
            </div>
        </div>

        <div id="phase-2" class="phase">
            <h1>IMPORTATION DONN√âES</h1>
            <div class="card">
                <h2>Action Requise</h2>
                <p style="font-size: 18px; margin-bottom: 30px;">
                    Les onglets sont cr√©√©s. Vous devez maintenant les remplir avec vos listes d'√©l√®ves.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <button onclick="google.script.host.close()" class="btn btn-secondary">
                        <i class="fas fa-door-open"></i> 1. QUITTER POUR REMPLIR
                    </button>
                    <button onclick="runDiagnostics()" class="btn btn-primary">
                        <i class="fas fa-sync"></i> 2. CONSOLIDER & V√âRIFIER
                    </button>
                </div>
            </div>
        </div>

        <div id="phase-3" class="phase">
            <h1>STRAT√âGIE</h1>
            <div class="card">
                <h2>D√©finition des Quotas</h2>
                <p style="margin-bottom: 20px;">Configurez les niveaux attendus pour chaque classe cible.</p>
                <button onclick="google.script.run.ouvrirConfigurationComplete()" class="btn btn-primary">
                    <i class="fas fa-sliders-h"></i> OUVRIR LE CONFIGURATEUR
                </button>
                <button onclick="goToPhase(4)" class="btn btn-success">
                    <i class="fas fa-check"></i> VALIDER
                </button>
            </div>
        </div>

        <div id="phase-4" class="phase">
            <h1>MOTEUR ULTIMATE</h1>
            <div class="card">
                <h2>Lancement du Calcul</h2>
                <p style="margin-bottom: 20px;">L'algorithme va optimiser la r√©partition avec asym√©trie pond√©r√©e.</p>
                <button onclick="runEngine()" class="btn btn-primary">
                    <i class="fas fa-rocket"></i> LANCER L'OPTIMISATION
                </button>
            </div>
        </div>

        <div id="phase-5" class="phase">
            <h1>PILOTAGE FINAL</h1>
            <div class="card">
                <h2>Validation & Finalisation</h2>
                <button onclick="openProfsInterface()" class="btn btn-secondary">
                    <i class="fas fa-users"></i> INTERFACE PROFS (SWAP)
                </button>
                <button onclick="finalize()" class="btn btn-success">
                    <i class="fas fa-lock"></i> FINALISER (CR√âER FIN)
                </button>
            </div>
        </div>

    </main>

    <script>
        function goToPhase(n) {
            document.querySelectorAll('.phase').forEach(e => e.classList.remove('active'));
            document.getElementById('phase-'+n).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('nav-'+n).classList.add('active');
        }

        function runInit() {
            const btn = document.querySelector('#phase-1 .btn-primary');
            btn.innerText = "‚è≥ CR√âATION EN COURS...";

            // R√©cup√©ration dynamique des champs (Plus rien en dur !)
            const form = {
                adminPassword: document.getElementById('config-pwd').value,
                niveau: document.getElementById('config-level').value,
                nbSources: parseInt(document.getElementById('config-nb-src').value),
                nbDest: parseInt(document.getElementById('config-nb-dest').value),
                // On prend ce que l'utilisateur a tap√©
                lv2: document.getElementById('config-lv2').value,
                opt: document.getElementById('config-opt').value,
                dispo: document.getElementById('config-dispo').value // Nouveau champ DISPO
            };

            google.script.run.withSuccessHandler(res => {
                btn.innerText = "üî® LANCER LA CONSTRUCTION";
                if(res.success) {
                    alert("‚úÖ " + res.message);
                    goToPhase(2);
                } else {
                    alert("‚ùå ERREUR: " + res.error);
                }
            }).withFailureHandler(err => {
                btn.innerText = "üî® LANCER LA CONSTRUCTION";
                alert("‚ùå ERREUR CRITIQUE: " + err.message);
            }).v3_runInitializationWithForm(form);
        }

        function runDiagnostics() {
            google.script.run.withSuccessHandler(() => {
                alert("‚úÖ Donn√©es consolid√©es avec succ√®s.");
                goToPhase(3);
            }).withFailureHandler(err => {
                alert("‚ùå Erreur: " + err.message);
            }).v3_runDiagnostics();
        }

        function runEngine() {
            google.script.run.withSuccessHandler(() => {
                alert("‚úÖ Calcul lanc√© avec succ√®s !");
                goToPhase(5);
            }).withFailureHandler(err => {
                alert("‚ùå Erreur moteur: " + err.message);
            }).v3_runGeneration();
        }

        function openProfsInterface() {
            google.script.run.withSuccessHandler(() => {
                alert("Interface professeurs ouverture...");
            }).v3_setBridgeContext('TEST', '');
        }

        function finalize() {
            if(confirm("Cr√©er les onglets d√©finitifs (FIN) ?")) {
                google.script.run.withSuccessHandler(() => {
                    alert("‚úÖ Finalisation termin√©e !");
                }).withFailureHandler(err => {
                    alert("‚ùå Erreur: " + err.message);
                }).v3_finalizeProcess();
            }
        }
    </script>
</body>
</html>
