<!DOCTYPE html>
<html lang="fr">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>PILOTAGE EXPERT V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1; --bg-dark: #0f172a; --text: #f8fafc; --card: #1e293b;
            --success: #22c55e; --warning: #eab308; --danger: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; height: 100vh; display: grid; grid-template-columns: 280px 1fr 300px; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { background: #020617; padding: 20px; border-right: 1px solid #334155; display: flex; flex-direction: column; }
        .brand { font-size: 20px; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; color: white; }
        .nav-item { padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #94a3b8; font-weight: 600; transition: 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }

        /* MAIN */
        .main { padding: 40px; overflow-y: auto; }
        .phase { display: none; animation: fadeIn 0.3s; }
        .phase.active { display: block; }
        .card { background: var(--card); padding: 30px; border-radius: 16px; border: 1px solid #334155; margin-bottom: 20px; }

        h1 { font-size: 28px; font-weight: 900; margin-bottom: 10px; }
        h2 { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 20px; text-transform: uppercase; }
        label { display: block; font-size: 12px; font-weight: 700; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; }

        input, select { width: 100%; background: #0f172a; border: 2px solid #334155; color: white; padding: 12px; border-radius: 6px; font-weight: 600; font-size: 14px; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }

        /* BOUTONS AVEC SPINNER */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; text-transform: uppercase; transition: 0.2s; }
        .btn:disabled { opacity: 0.6; cursor: wait; }
        .btn-primary { background: var(--primary); color: white; margin-bottom: 10px; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-success { background: var(--success); color: #022c22; }
        .btn-secondary { background: #334155; color: white; }

        /* TABLEAU √âDITEUR */
        .editor-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .editor-table th { text-align: left; padding: 10px; color: #94a3b8; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #334155; }
        .editor-table td { padding: 10px; border-bottom: 1px solid #334155; }
        .editor-table input { margin: 0; padding: 8px; width: 70px; text-align: center; }

        /* PANEL DROITE */
        .panel-right { background: #1e293b; border-left: 1px solid #334155; padding: 25px; overflow-y: auto; }
        .status-box { background: #0f172a; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #334155; }
        .status-val { font-size: 32px; font-weight: 900; color: white; }
        .status-lbl { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }

        /* SPINNER CSS */
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; display: none; }
        .btn.loading .spinner { display: block; }
        .btn.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="brand"><i class="fas fa-rocket"></i> PILOTE V3</div>
    <nav>
        <div class="nav-item active" onclick="goTo(1)" id="nav-1"><i class="fas fa-hammer"></i> INIT</div>
        <div class="nav-item" onclick="goTo(2)" id="nav-2"><i class="fas fa-database"></i> DATA</div>
        <div class="nav-item" onclick="goTo(3)" id="nav-3"><i class="fas fa-chess-board"></i> STRUCTURE</div>
        <div class="nav-item" onclick="goTo(4)" id="nav-4"><i class="fas fa-cogs"></i> MOTEUR</div>
        <div class="nav-item" onclick="goTo(5)" id="nav-5"><i class="fas fa-check"></i> FINAL</div>
    </nav>
</aside>

<main class="main">

    <div id="phase-1" class="phase active">
        <h1>INITIALISATION DU PROJET</h1>
        <div class="card">
            <h2>1. Architecture</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div><label>üîí Mdp Admin</label><input type="password" id="pwd" value="admin123"></div>
                <div>
                    <label>üéì Niveau</label>
                    <select id="niv">
                        <option value="6¬∞">6√®me</option>
                        <option value="5¬∞" selected>5√®me</option>
                        <option value="4¬∞">4√®me</option>
                        <option value="3¬∞">3√®me</option>
                        <option value="CM2">CM2</option>
                        <option value="2nde">2nde</option>
                    </select>
                </div>
                <div><label>üìÇ Sources</label><input type="number" id="src" value="6"></div>
            </div>

            <hr style="border: 0; border-top: 1px solid #334155; margin: 20px 0;">

            <h2>2. Dictionnaire des Codes</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div><label>üåç LV2</label><input type="text" id="lv2" value="ANG, ALL, ESP, ITA" placeholder="Ex: ANG, ESP, ALL"></div>
                <div><label>üéØ Options</label><input type="text" id="opt" value="LATIN, CHAV" placeholder="Ex: LATIN, GREC"></div>
                <div><label>üìã Dispositifs</label><input type="text" id="dispo" value="PAI, PPRE, ULIS" placeholder="Ex: PAI, PPRE"></div>
            </div>

            <button onclick="runInit()" id="btn-init" class="btn btn-primary" style="margin-top: 20px;">
                <div class="spinner"></div>
                <span>LANCER LA CONSTRUCTION</span>
            </button>
        </div>
    </div>

    <div id="phase-2" class="phase">
        <h1>REMPLISSAGE DES DONN√âES</h1>
        <div class="card">
            <h2>Saisie Manuelle</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">Les onglets sont cr√©√©s. Fermez la console, remplissez les donn√©es sources, et revenez pour consolider.</p>
            <button onclick="google.script.host.close()" class="btn btn-secondary" style="margin-bottom: 20px;">
                <i class="fas fa-door-open"></i> QUITTER POUR REMPLIR
            </button>

            <h2>Consolidation des Donn√©es</h2>
            <button onclick="runConso()" id="btn-conso" class="btn btn-primary">
                <div class="spinner"></div>
                <span>CONSOLIDER & V√âRIFIER</span>
            </button>
        </div>
    </div>

    <div id="phase-3" class="phase">
        <h1>STRAT√âGIE DE R√âPARTITION</h1>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>D√©finition des Classes Cibles</h2>
                <button onclick="loadStructure()" id="btn-load-struct" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-sync"></i> Actualiser
                </button>
            </div>

            <div style="overflow-x: auto; margin: 20px 0; border: 1px solid #334155; border-radius: 8px;">
                <table class="editor-table" id="struct-table">
                    <thead>
                        <tr id="struct-header">
                            <th>CLASSE</th>
                            <th>CAPACIT√â</th>
                        </tr>
                    </thead>
                    <tbody id="struct-body">
                        <tr><td colspan="5" style="text-align:center; padding: 30px;">Chargement...</td></tr>
                    </tbody>
                </table>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <div style="color: var(--warning); font-size: 13px; font-weight: 600;">
                    <i class="fas fa-info-circle"></i> Total Places : <span id="total-cap">0</span>
                </div>
                <button onclick="saveStructure()" id="btn-save-struct" class="btn btn-success" style="width: 200px;">
                    <div class="spinner"></div>
                    <span>VALIDER</span>
                </button>
            </div>
        </div>
    </div>

    <div id="phase-4" class="phase">
        <h1>OPTIMISATION</h1>
        <div class="card">
            <h2>Lancement du Moteur</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">L'algorithme va r√©partir les √©l√®ves selon votre structure et g√©n√©rer les classes TEST optimis√©es.</p>
            <button onclick="runEngine()" id="btn-engine" class="btn btn-primary" style="height: 80px; font-size: 20px;">
                <div class="spinner"></div>
                <span>D√âMARRER LE CALCUL</span>
            </button>
        </div>
    </div>

    <div id="phase-5" class="phase">
        <h1>FINALISATION</h1>
        <div class="card">
            <h2>G√©n√©ration des Onglets FIN</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">Cr√©er les onglets d√©finitifs √† partir des r√©sultats TEST.</p>
            <button onclick="finalize()" id="btn-fin" class="btn btn-success">
                <div class="spinner"></div>
                <span>G√âN√âRER ONGLETS "FIN"</span>
            </button>
        </div>
    </div>

</main>

<aside class="panel-right">
    <h2 style="font-size: 12px; color: #64748b; margin-bottom: 20px;">√âTAT SYST√àME</h2>

    <div class="status-box">
        <div class="status-val" id="stat-msg">PR√äT</div>
        <div class="status-lbl">STATUS</div>
    </div>

    <div class="status-box">
        <div class="status-val" id="metric-eleves">0</div>
        <div class="status-lbl">√âL√àVES</div>
    </div>
</aside>

<script>
    // === NAVIGATION ===
    function goTo(n) {
        document.querySelectorAll('.phase').forEach(e => e.classList.remove('active'));
        document.getElementById('phase-'+n).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('nav-'+n).classList.add('active');

        if(n === 3) loadStructure(); // Charger la structure auto
    }

    // === UI Helpers ===
    function setLoading(btnId, isLoading) {
        const btn = document.getElementById(btnId);
        if(!btn) return;
        if(isLoading) {
            btn.classList.add('loading');
            btn.disabled = true;
            document.getElementById('stat-msg').innerText = "TRAITEMENT...";
            document.getElementById('stat-msg').style.color = "#eab308";
        } else {
            btn.classList.remove('loading');
            btn.disabled = false;
            document.getElementById('stat-msg').innerText = "PR√äT";
            document.getElementById('stat-msg').style.color = "#22c55e";
        }
    }

    // === ACTIONS ===

    function runInit() {
        setLoading('btn-init', true);
        const form = {
            adminPassword: document.getElementById('pwd').value,
            niveau: document.getElementById('niv').value,
            nbSources: parseInt(document.getElementById('src').value),
            nbDest: 6,
            lv2: document.getElementById('lv2').value,
            opt: document.getElementById('opt').value,
            dispo: document.getElementById('dispo').value
        };

        google.script.run.withSuccessHandler(res => {
            setLoading('btn-init', false);
            if(res.success) {
                alert("‚úÖ " + res.message);
                goTo(2);
            }
            else alert("‚ùå Erreur: " + res.error);
        }).withFailureHandler(err => {
            setLoading('btn-init', false);
            alert("‚ùå Erreur: " + err.message);
        }).v3_runInitializationWithForm(form);
    }

    function runConso() {
        setLoading('btn-conso', true);
        google.script.run.withSuccessHandler(() => {
            setLoading('btn-conso', false);
            alert("‚úÖ Consolidation r√©ussie !");
            document.getElementById('metric-eleves').innerText = "OK";
            goTo(3);
        }).withFailureHandler(err => {
            setLoading('btn-conso', false);
            alert("‚ùå Erreur: " + err.message);
        }).v3_runDiagnostics();
    }

    // === LOGIQUE STRUCTURE INT√âGR√âE ===
    let currentStructure = null;

    function loadStructure() {
        document.getElementById('struct-body').innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px">Chargement...</td></tr>';

        google.script.run.withSuccessHandler(data => {
            if(!data.success) {
                alert("Erreur chargement structure: " + data.error);
                return;
            }
            currentStructure = data;
            renderStructureTable(data);
        }).withFailureHandler(err => {
            alert("Erreur: " + err.message);
        }).v3_getStructureDataForEditor();
    }

    function renderStructureTable(data) {
        const thead = document.getElementById('struct-header');
        const tbody = document.getElementById('struct-body');

        // 1. Construire les en-t√™tes dynamiques (LV2 + OPT)
        let headersHTML = '<th>CLASSE</th><th>CAPACIT√â</th>';
        const allOptions = [...data.lv2, ...data.options]; // Fusion des listes

        allOptions.forEach(opt => {
            headersHTML += `<th>${opt}</th>`;
        });
        thead.innerHTML = headersHTML;

        // 2. Construire les lignes
        let rowsHTML = '';
        data.classes.forEach((cls, idx) => {
            let row = `<tr>
                <td><input type="text" value="${cls.name}" readonly style="background:#0f172a; border:none; font-weight:800; width:100%;"></td>
                <td><input type="number" class="input-cap" value="${cls.capacity}" onchange="updateTotal()"></td>`;

            allOptions.forEach(opt => {
                const val = cls.quotas && cls.quotas[opt] ? cls.quotas[opt] : 0;
                row += `<td><input type="number" class="input-opt" data-cls="${idx}" data-opt="${opt}" value="${val}" min="0"></td>`;
            });

            row += '</tr>';
            rowsHTML += row;
        });
        tbody.innerHTML = rowsHTML;
        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.input-cap').forEach(inp => total += parseInt(inp.value)||0);
        document.getElementById('total-cap').innerText = total;
    }

    function saveStructure() {
        setLoading('btn-save-struct', true);

        // Mettre √† jour les quotas depuis les inputs
        const inputs = document.querySelectorAll('.input-opt');
        inputs.forEach(inp => {
            const clsIdx = parseInt(inp.dataset.cls);
            const opt = inp.dataset.opt;
            const val = parseInt(inp.value) || 0;
            if(!currentStructure.classes[clsIdx].quotas) currentStructure.classes[clsIdx].quotas = {};
            currentStructure.classes[clsIdx].quotas[opt] = val;
        });

        // Mettre √† jour les capacit√©s
        document.querySelectorAll('.input-cap').forEach((inp, idx) => {
            currentStructure.classes[idx].capacity = parseInt(inp.value) || 30;
        });

        google.script.run.withSuccessHandler(res => {
            setLoading('btn-save-struct', false);
            if(res.success) {
                alert("‚úÖ Structure enregistr√©e !");
                goTo(4);
            } else {
                alert("‚ùå Erreur: " + res.error);
            }
        }).withFailureHandler(err => {
            setLoading('btn-save-struct', false);
            alert("‚ùå Erreur: " + err.message);
        }).v3_saveStructureFromEditor(currentStructure);
    }

    function runEngine() {
        setLoading('btn-engine', true);
        google.script.run.withSuccessHandler(res => {
            setLoading('btn-engine', false);
            if(res.success) {
                alert("‚úÖ Calcul termin√© !");
                goTo(5);
            } else {
                alert("‚ùå Erreur: " + res.error);
            }
        }).withFailureHandler(err => {
            setLoading('btn-engine', false);
            alert("‚ùå Erreur: " + err.message);
        }).v3_runGeneration();
    }

    function finalize() {
        if(confirm("Cr√©er les onglets FIN ? Cette action est irr√©versible.")) {
            setLoading('btn-fin', true);
            google.script.run.withSuccessHandler(() => {
                setLoading('btn-fin', false);
                alert("‚úÖ Finalisation compl√©t√©e !");
            }).withFailureHandler(err => {
                setLoading('btn-fin', false);
                alert("‚ùå Erreur: " + err.message);
            }).v3_finalizeProcess();
        }
    }

</script>
</body>
</html>
