<!DOCTYPE html>
<html lang="fr">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Console de Pilotage V3 - Expert Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* =====================================================================
         * DESIGN SYSTEM "BOLD & CLEAR"
         * ===================================================================*/
        :root {
            --primary-500: #667eea; --primary-600: #5468d8;
            --bg-primary: #ffffff; --bg-secondary: #f8fafc; --text-primary: #1e293b;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --sidebar-width: 280px;
            --font-family: 'Inter', -apple-system, sans-serif;
        }
        [data-theme="dark"] {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --text-primary: #f8fafc;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
            font-weight: 500;
        }

        /* LAYOUT */
        .app-container { display: grid; grid-template-columns: var(--sidebar-width) 1fr; height: 100%; }

        /* SIDEBAR */
        .sidebar { background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%); color: white; padding: 20px; display: flex; flex-direction: column; }
        .brand { font-size: 18px; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; opacity: 0.7; transition: 0.2s; font-weight: 700; }
        .nav-item:hover { opacity: 1; background: rgba(255,255,255,0.1); }
        .nav-item.active { opacity: 1; background: var(--primary-500); font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .nav-item.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

        /* CONTENT */
        .main-content { padding: 40px; overflow-y: auto; background: var(--bg-secondary); }
        .phase { display: none; animation: fadeIn 0.3s ease; }
        .phase.active { display: block; }

        /* COMPONENTS */
        .card { background: var(--bg-primary); border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { font-size: 32px; font-weight: 900; margin-bottom: 10px; letter-spacing: -1px; }
        h2 { font-size: 22px; font-weight: 800; margin-bottom: 20px; color: var(--primary-500); }

        label {
            display: block;
            font-size: 14px;
            font-weight: 800;
            color: #334155;
            margin-bottom: 8px;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            background: #ffffff;
            color: #0f172a;
            font-weight: 700;
            font-size: 16px;
        }

        input:focus, select:focus {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
            outline: none;
        }

        .btn {
            padding: 16px 32px;
            border-radius: 8px;
            border: none;
            font-weight: 800;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary-500); color: white; }
        .btn-primary:hover { background: var(--primary-600); transform: translateY(-1px); }
        .btn-secondary { background: #e2e8f0; color: #475569; }
        .btn-success { background: var(--success); color: white; }

        /* UTILS */
        .alert { padding: 15px; border-radius: 8px; background: #eff6ff; border-left: 4px solid var(--primary-500); margin: 20px 0; font-size: 14px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* GAUGE */
        .gauge-container { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .gauge-bar { height: 100%; background: var(--success); width: 0%; transition: width 1s; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="brand"><i class="fas fa-rocket"></i> PILOTE V3</div>

        <nav>
            <div class="nav-item active" onclick="goToPhase(1)" id="nav-1">
                <i class="fas fa-hammer"></i> 1. Architecture
            </div>
            <div class="nav-item disabled" onclick="goToPhase(2)" id="nav-2">
                <i class="fas fa-users"></i> 2. Donn√©es
            </div>
            <div class="nav-item disabled" onclick="goToPhase(3)" id="nav-3">
                <i class="fas fa-chess-board"></i> 3. Strat√©gie
            </div>
            <div class="nav-item disabled" onclick="goToPhase(4)" id="nav-4">
                <i class="fas fa-cogs"></i> 4. Moteur
            </div>
            <div class="nav-item disabled" onclick="goToPhase(5)" id="nav-5">
                <i class="fas fa-flag-checkered"></i> 5. Pilotage
            </div>
        </nav>

        <div style="margin-top: auto; font-size: 12px; opacity: 0.5;">
            Status: <span id="system-status">Connect√©</span>
        </div>
    </aside>

    <main class="main-content">

        <div id="phase-1" class="phase active">
            <h1>1. Architecture & Param√®tres</h1>
            <div class="card">
                <h2>Configuration du Socle</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label>Mot de Passe Admin</label>
                        <input type="password" id="config-pwd" placeholder="Requis pour initialiser">
                    </div>
                    <div>
                        <label>Niveau Scolaire</label>
                        <select id="config-level">
                            <optgroup label="√âcole Primaire">
                                <option value="CP">CP</option>
                                <option value="CE1">CE1</option>
                                <option value="CE2">CE2</option>
                                <option value="CM1">CM1</option>
                                <option value="CM2">CM2</option>
                            </optgroup>
                            <optgroup label="Coll√®ge">
                                <option value="6¬∞" selected>6√®me</option>
                                <option value="5¬∞">5√®me</option>
                                <option value="4¬∞">4√®me</option>
                                <option value="3¬∞">3√®me</option>
                            </optgroup>
                            <optgroup label="Lyc√©e">
                                <option value="2nde">2nde</option>
                                <option value="1√®re">1√®re</option>
                                <option value="Term">Terminale</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label>Nb Classes Sources</label>
                        <input type="number" id="config-nb-src" value="6">
                    </div>
                    <div>
                        <label>Nb Classes Cibles</label>
                        <input type="number" id="config-nb-dest" value="6">
                    </div>
                </div>

                <div class="alert">
                    <i class="fas fa-info-circle"></i>
                    Ce bouton va <strong>cr√©er les onglets vides</strong> dans le tableur. Les param√®tres seront enregistr√©s.
                </div>

                <button onclick="runInit()" class="btn btn-primary" style="width: 100%; justify-content: center;">
                    <i class="fas fa-play"></i> LANCER LA CONSTRUCTION
                </button>
            </div>
        </div>

        <div id="phase-2" class="phase">
            <h1>2. Remplissage des Donn√©es</h1>
            <div class="card">
                <h2>Action Requise</h2>
                <p>Les onglets ont √©t√© cr√©√©s. Vous devez maintenant y coller vos listes d'√©l√®ves.</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <button onclick="google.script.host.close()" class="btn btn-secondary">
                        <i class="fas fa-external-link-alt"></i> Fermer pour remplir
                    </button>
                    <button onclick="runDiagnostics()" class="btn btn-primary">
                        <i class="fas fa-sync"></i> V√©rifier & Consolider
                    </button>
                </div>
            </div>
        </div>

        <div id="phase-3" class="phase">
            <h1>3. Strat√©gie de R√©partition</h1>
            <div class="card">
                <h2>Dashboard Strat√©gique</h2>

                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Taux de Remplissage</span>
                    <span id="fill-rate">0%</span>
                </div>
                <div class="gauge-container">
                    <div id="fill-gauge" class="gauge-bar"></div>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <div style="font-size: 32px; font-weight: 800; color: var(--primary-500);" id="total-places">0</div>
                    <div style="font-size: 12px; text-transform: uppercase; color: #64748b;">Places Disponibles</div>
                </div>

                <button onclick="openConfig()" class="btn btn-primary" style="width: 100%; margin-top: 20px; justify-content: center;">
                    <i class="fas fa-sliders-h"></i> CONFIGURER LA STRUCTURE (4¬∞4 = 6 ITA...)
                </button>

                <button onclick="validateStrategy()" class="btn btn-success" style="width: 100%; margin-top: 10px; justify-content: center;">
                    <i class="fas fa-check"></i> Valider la Strat√©gie
                </button>
            </div>
        </div>

        <div id="phase-4" class="phase">
            <h1>4. Moteur Ultimate</h1>
            <div class="card">
                <h2>Lancement du Calcul</h2>
                <p>L'algorithme va r√©partir les √©l√®ves en respectant vos quotas et en √©quilibrant les niveaux.</p>
                <button onclick="runEngine()" class="btn btn-primary" style="width: 100%; height: 60px; font-size: 18px; justify-content: center;">
                    <i class="fas fa-rocket"></i> D√âMARRER L'OPTIMISATION
                </button>
            </div>
        </div>

        <div id="phase-5" class="phase">
            <h1>5. Pilotage Final</h1>
            <div class="card">
                <h2>Ajustements & Validation</h2>
                <button onclick="openSwap()" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-users-cog"></i> Ouvrir Interface Profs (Swap)
                </button>
                <button onclick="finalize()" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-lock"></i> Finaliser (Onglets FIN)
                </button>
            </div>
        </div>

    </main>
</div>

<script>
    // --- NAVIGATION ---
    function goToPhase(n) {
        document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));
        document.getElementById('phase-'+n).classList.add('active');

        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('nav-'+n).classList.add('active');

        // D√©bloquer le suivant (simulation de progression)
        if(n < 5) document.getElementById('nav-'+(n+1)).classList.remove('disabled');

        if(n === 3) refreshStats();
    }

    // --- ACTIONS SERVEUR ---
    function runInit() {
        const pwd = document.getElementById('config-pwd').value;
        if(!pwd) return alert('Mot de passe requis');

        const formData = {
            adminPassword: pwd,
            niveau: document.getElementById('config-level').value,
            nbSources: parseInt(document.getElementById('config-nb-src').value),
            nbDest: parseInt(document.getElementById('config-nb-dest').value),
            lv2: "ESP,ITA", // D√©faut pour simplification
            opt: "LATIN"   // D√©faut
        };

        google.script.run.withSuccessHandler(() => {
            alert('Initialisation termin√©e !');
            goToPhase(2);
        }).v3_runInitializationWithForm(formData);
    }

    function runDiagnostics() {
        google.script.run.withSuccessHandler(() => {
            alert('Donn√©es consolid√©es !');
            goToPhase(3);
        }).v3_runDiagnostics();
    }

    function openConfig() {
        google.script.run.ouvrirConfigurationComplete();
    }

    function refreshStats() {
        google.script.run.withSuccessHandler(data => {
            if(data.success) {
                document.getElementById('total-places').innerText = data.totalPlaces;
                // Simuler un calcul de ratio pour l'exemple
                document.getElementById('fill-rate').innerText = "En attente";
            }
        }).v3_getStructureInfo();
    }

    function validateStrategy() {
        goToPhase(4);
    }

    function runEngine() {
        google.script.run.withSuccessHandler(() => {
            alert('Calcul termin√© !');
            goToPhase(5);
        }).v3_runGeneration();
    }

    function openSwap() {
        google.script.run.withSuccessHandler(() => {
           window.open(google.script.host.origin + google.script.host.path, '_blank');
        }).v3_setBridgeContext('TEST', '');
    }

    function finalize() {
        if(confirm("Cr√©er les onglets d√©finitifs ?")) {
             google.script.run.v3_finalizeProcess();
        }
    }

    // ===================================================================
    // üíì LE POULS (HEARTBEAT) - Version S√ªre
    // ===================================================================
    function startHeartbeat() {
        // Un seul intervalle propre - Toutes les 5 secondes
        setInterval(() => {
            // V√©rifier que google.script.run est disponible
            if(typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run.withSuccessHandler(updateMetrics).v3_getMetrics();
            }
        }, 5000);

        // Un seul appel initial avec d√©lai (laisser le temps au chargement)
        setTimeout(() => {
            if(typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run.withSuccessHandler(updateMetrics).v3_getMetrics();
            }
        }, 1000);

        // Horloge (optionnel)
        setInterval(updateClock, 1000);
    }

    function updateMetrics(metrics) {
        // Met √† jour les chiffres si vous en avez besoin
        if (metrics) {
            console.log('M√©triques re√ßues:', metrics);
        }
    }

    function updateClock() {
        const el = document.getElementById('current-time');
        if(el) {
            const now = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
            el.textContent = now;
        }
    }

    // ===================================================================
    // üöÄ INITIALISATION - Au chargement de la page
    // ===================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // Lancer le heartbeat
        startHeartbeat();
        console.log('‚úÖ Console V3 Expert charg√©e - Heartbeat actif');
    });
</script>
</body>
</html>
