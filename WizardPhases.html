<script>
/**
 * ===================================================================
 * WIZARD - WORKFLOW COMPLET
 * ===================================================================
 *
 * WORKFLOW :
 * 1. Initialisation (mdp, niveau, nb classes)
 * 2. Param√©trage LV2/Options (input CSV)
 * 3. CHOIX parcours A ou B
 *    A: Sources ‚Üí Consolidation ‚Üí Stats ‚Üí Config
 *    B: Config directe
 * 4. Configuration compl√®te (inline, pas popup)
 * 5. Lancement LEGACY
 *
 * INTERFACE : Sections accordion repliables
 * ===================================================================
 */

(function() {
  'use strict';

  if (typeof document === 'undefined') {
    console.warn('[Wizard] Skipping client-side code in server context');
    return;
  }

  // ===================================================================
  // STATE GLOBAL
  // ===================================================================
  window.wizardState = {
    currentStep: 1,
    parcours: null, // 'A' ou 'B'
    data: {
      // Phase 1
      motDePasse: '',
      niveau: '6¬∞',
      nbSourcesClasses: 6,
      nbDestinations: 5,

      // Phase 2
      lv2List: [],
      optionsList: [],

      // Phase 3
      dataReady: false,
      structureReady: false,

      // Phase 4
      pipelineExecuted: false
    }
  };

  // ===================================================================
  // UTILITAIRES ACCORDION
  // ===================================================================
  function createAccordionSection(id, title, icon, content, isOpen = false) {
    return `
      <div class="accordion-section ${isOpen ? 'open' : ''}">
        <div class="accordion-header" onclick="toggleAccordion('${id}')">
          <div class="accordion-title">
            <i class="fas ${icon}"></i>
            <span>${title}</span>
          </div>
          <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="accordion-content" id="${id}">
          ${content}
        </div>
      </div>
    `;
  }

  window.toggleAccordion = function(id) {
    const section = document.getElementById(id).closest('.accordion-section');
    const isOpen = section.classList.contains('open');

    // Fermer toutes les sections (optionnel)
    // document.querySelectorAll('.accordion-section').forEach(s => s.classList.remove('open'));

    // Toggle la section cliqu√©e
    if (isOpen) {
      section.classList.remove('open');
    } else {
      section.classList.add('open');
    }
  };

  // ===================================================================
  // PHASE 1 : INITIALISATION
  // ===================================================================
  window.loadPhase1Content = function() {
    const container = document.getElementById('phase-1-content');

    const html = `
      <style>
        .accordion-section {
          margin-bottom: 16px;
          background: white;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          overflow: hidden;
        }
        .accordion-header {
          padding: 20px;
          cursor: pointer;
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f8f9fa;
          transition: background 0.2s;
        }
        .accordion-header:hover {
          background: #e9ecef;
        }
        .accordion-title {
          display: flex;
          align-items: center;
          gap: 12px;
          font-size: 16px;
          font-weight: 600;
          color: #1e293b;
        }
        .accordion-title i {
          font-size: 20px;
          color: #667eea;
        }
        .accordion-icon {
          transition: transform 0.3s;
          color: #94a3b8;
        }
        .accordion-section.open .accordion-icon {
          transform: rotate(180deg);
        }
        .accordion-content {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.3s ease-out;
        }
        .accordion-section.open .accordion-content {
          max-height: 2000px;
        }
        .accordion-body {
          padding: 24px;
        }
        .form-group {
          margin-bottom: 20px;
        }
        .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 500;
          color: #475569;
        }
        .form-group input,
        .form-group select {
          width: 100%;
          padding: 10px 14px;
          border: 1px solid #cbd5e1;
          border-radius: 6px;
          font-size: 14px;
          transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus {
          outline: none;
          border-color: #667eea;
        }
        .btn {
          padding: 12px 24px;
          border: none;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }
        .btn-primary {
          background: #667eea;
          color: white;
        }
        .btn-primary:hover {
          background: #5568d3;
        }
        .help-text {
          font-size: 13px;
          color: #64748b;
          margin-top: 4px;
        }
      </style>

      <h2 style="margin-bottom: 24px; color: #1e293b;">
        <i class="fas fa-play-circle"></i> Initialisation du Wizard
      </h2>

      ${createAccordionSection('step1-auth', 'Mot de passe administrateur', 'fa-lock', `
        <div class="accordion-body">
          <div class="form-group">
            <label for="mdp-admin">Mot de passe :</label>
            <input type="password" id="mdp-admin" placeholder="Entrez le mot de passe administrateur" />
            <div class="help-text">Requis pour sauvegarder la configuration</div>
          </div>
        </div>
      `, true)}

      ${createAccordionSection('step1-niveau', 'Choix du niveau scolaire', 'fa-graduation-cap', `
        <div class="accordion-body">
          <div class="form-group">
            <label for="niveau-select">Niveau :</label>
            <select id="niveau-select">
              <option value="6¬∞">6√®me</option>
              <option value="5¬∞">5√®me</option>
              <option value="4¬∞">4√®me</option>
              <option value="3¬∞">3√®me</option>
            </select>
          </div>
        </div>
      `)}

      ${createAccordionSection('step1-classes', 'Nombre de classes', 'fa-users', `
        <div class="accordion-body">
          <div class="form-group">
            <label for="nb-sources">Nombre de classes sources :</label>
            <input type="number" id="nb-sources" value="6" min="1" max="20" />
            <div class="help-text">Exemple : 6 pour 6¬∞1, 6¬∞2, ..., 6¬∞6</div>
          </div>

          <div class="form-group">
            <label for="nb-dest">Nombre de classes √† cr√©er (destinations) :</label>
            <input type="number" id="nb-dest" value="5" min="1" max="20" />
            <div class="help-text">Exemple : 5 pour 6e1, 6e2, ..., 6e5</div>
          </div>
        </div>
      `)}

      <div style="margin-top: 32px; text-align: right;">
        <button class="btn btn-primary" onclick="validatePhase1()">
          <i class="fas fa-arrow-right"></i> Suivant : Param√©trage LV2/Options
        </button>
      </div>
    `;

    container.innerHTML = html;
  };

  window.validatePhase1 = function() {
    // R√©cup√©rer les valeurs
    wizardState.data.motDePasse = document.getElementById('mdp-admin').value;
    wizardState.data.niveau = document.getElementById('niveau-select').value;
    wizardState.data.nbSourcesClasses = parseInt(document.getElementById('nb-sources').value);
    wizardState.data.nbDestinations = parseInt(document.getElementById('nb-dest').value);

    // Validation
    if (!wizardState.data.motDePasse) {
      alert('Veuillez entrer le mot de passe administrateur');
      return;
    }

    if (wizardState.data.nbSourcesClasses < 1 || wizardState.data.nbDestinations < 1) {
      alert('Le nombre de classes doit √™tre sup√©rieur √† 0');
      return;
    }

    // Passer √† la phase 2
    goToPhase(2);
  };

  // ===================================================================
  // PHASE 2 : LV2 / OPTIONS
  // ===================================================================
  window.loadPhase2Content = function() {
    const container = document.getElementById('phase-2-content');

    const html = `
      <h2 style="margin-bottom: 24px; color: #1e293b;">
        <i class="fas fa-language"></i> Param√©trage LV2 et Options
      </h2>

      ${createAccordionSection('step2-lv2', 'LV2 propos√©es', 'fa-globe', `
        <div class="accordion-body">
          <div class="form-group">
            <label for="lv2-input">Saisir les SIGLES des LV2 s√©par√©s par des virgules :</label>
            <input type="text" id="lv2-input" placeholder="ESP,ITA,ALL" />
            <div class="help-text">Exemple : ESP,ITA,ALL (laisser vide s'il n'y a aucune LV2)</div>
          </div>
        </div>
      `, true)}

      ${createAccordionSection('step2-options', 'Options sp√©cifiques', 'fa-star', `
        <div class="accordion-body">
          <div class="form-group">
            <label for="options-input">Saisir les SIGLES des options s√©par√©s par des virgules :</label>
            <input type="text" id="options-input" placeholder="LATIN,GREC,CHAV" />
            <div class="help-text">Exemple : LATIN,GREC,CHAV (laisser vide s'il n'y a aucune option)</div>
          </div>
        </div>
      `)}

      <div style="margin-top: 32px; display: flex; justify-content: space-between;">
        <button class="btn" onclick="goToPhase(1)" style="background: #e2e8f0; color: #475569;">
          <i class="fas fa-arrow-left"></i> Retour
        </button>
        <button class="btn btn-primary" onclick="validatePhase2()">
          <i class="fas fa-arrow-right"></i> Suivant : Choix du parcours
        </button>
      </div>
    `;

    container.innerHTML = html;
  };

  window.validatePhase2 = function() {
    // R√©cup√©rer et parser les LV2
    const lv2Input = document.getElementById('lv2-input').value;
    wizardState.data.lv2List = lv2Input ? lv2Input.split(',').map(s => s.trim().toUpperCase()).filter(Boolean) : [];

    // R√©cup√©rer et parser les Options
    const optInput = document.getElementById('options-input').value;
    wizardState.data.optionsList = optInput ? optInput.split(',').map(s => s.trim().toUpperCase()).filter(Boolean) : [];

    // Sauvegarder dans _CONFIG
    google.script.run
      .withSuccessHandler(() => {
        goToPhase(3);
      })
      .withFailureHandler((err) => {
        alert('Erreur sauvegarde : ' + err.message);
      })
      .wizard_saveInitialConfig(wizardState.data);
  };

  // ===================================================================
  // PHASE 3 : CHOIX DU PARCOURS
  // ===================================================================
  window.loadPhase3Content = function() {
    const container = document.getElementById('phase-3-content');

    const html = `
      <style>
        .choice-card {
          background: white;
          border: 2px solid #e2e8f0;
          border-radius: 12px;
          padding: 32px;
          margin-bottom: 24px;
          cursor: pointer;
          transition: all 0.3s;
        }
        .choice-card:hover {
          border-color: #667eea;
          box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
          transform: translateY(-2px);
        }
        .choice-card h3 {
          color: #1e293b;
          margin-bottom: 12px;
          font-size: 20px;
        }
        .choice-card p {
          color: #64748b;
          line-height: 1.6;
          margin-bottom: 16px;
        }
        .choice-card ul {
          color: #475569;
          margin-left: 24px;
          line-height: 1.8;
        }
        .choice-card .btn {
          margin-top: 16px;
          width: 100%;
        }
      </style>

      <h2 style="margin-bottom: 32px; color: #1e293b;">
        <i class="fas fa-route"></i> Choix du Parcours
      </h2>

      <p style="margin-bottom: 32px; color: #64748b; font-size: 15px;">
        Choisissez le parcours qui correspond √† votre situation :
      </p>

      <div class="choice-card">
        <h3><i class="fas fa-database" style="color: #10b981;"></i> Parcours A : Pr√©paration des donn√©es</h3>
        <p>
          Commencez par pr√©parer vos donn√©es √©l√®ves, puis configurez la structure des classes.
        </p>
        <ul>
          <li>Peupler les onglets sources (6¬∞1, 6¬∞2, etc.)</li>
          <li>Cr√©er les colonnes ID_ELEVE et NOM_PRENOM</li>
          <li>Consolider les donn√©es</li>
          <li>G√©n√©rer les statistiques (optionnel)</li>
          <li>Ensuite : Configuration compl√®te</li>
        </ul>
        <button class="btn btn-primary" onclick="choisirParcours('A')">
          <i class="fas fa-check"></i> Choisir Parcours A
        </button>
      </div>

      <div class="choice-card">
        <h3><i class="fas fa-sliders-h" style="color: #f59e0b;"></i> Parcours B : Configuration directe</h3>
        <p>
          Configurez d'abord la structure des classes, vous pourrez importer les donn√©es plus tard.
        </p>
        <ul>
          <li>D√©finir la structure des classes destinations</li>
          <li>Mapper origine ‚Üí destination</li>
          <li>D√©finir effectifs et quotas LV2/Options</li>
          <li>Plus tard : Import des donn√©es √©l√®ves</li>
        </ul>
        <button class="btn btn-primary" onclick="choisirParcours('B')" style="background: #f59e0b;">
          <i class="fas fa-check"></i> Choisir Parcours B
        </button>
      </div>

      <div style="margin-top: 32px; text-align: left;">
        <button class="btn" onclick="goToPhase(2)" style="background: #e2e8f0; color: #475569;">
          <i class="fas fa-arrow-left"></i> Retour
        </button>
      </div>
    `;

    container.innerHTML = html;
  };

  window.choisirParcours = function(parcours) {
    wizardState.parcours = parcours;

    if (parcours === 'A') {
      goToPhase(4); // Phase 4 = Parcours A
    } else {
      goToPhase(5); // Phase 5 = Configuration compl√®te (Parcours B)
    }
  };

  // ===================================================================
  // PHASE 4 : PARCOURS A - PR√âPARATION DONN√âES
  // ===================================================================
  window.loadPhase4Content = function() {
    const container = document.getElementById('phase-4-content');

    const html = `
      <h2 style="margin-bottom: 24px; color: #1e293b;">
        <i class="fas fa-database"></i> Parcours A : Pr√©paration des Donn√©es
      </h2>

      ${createAccordionSection('parcoursA-sources', '1. Peupler les onglets sources', 'fa-table', `
        <div class="accordion-body">
          <p style="margin-bottom: 16px; color: #64748b;">
            Remplissez les onglets sources cr√©√©s (6¬∞1, 6¬∞2, etc.) avec les donn√©es √©l√®ves.
          </p>
          <button class="btn btn-primary" onclick="ouvrirOngletsSourcesPourSaisie()">
            <i class="fas fa-edit"></i> Ouvrir les onglets pour saisie
          </button>
          <div style="margin-top: 16px;">
            <button class="btn" style="background: #e2e8f0; color: #475569;" onclick="genererNomPrenomID()">
              <i class="fas fa-cog"></i> G√©n√©rer ID_ELEVE et NOM_PRENOM
            </button>
          </div>
        </div>
      `, true)}

      ${createAccordionSection('parcoursA-consolidation', '2. Consolidation', 'fa-compress', `
        <div class="accordion-body">
          <p style="margin-bottom: 16px; color: #64748b;">
            Consolidez toutes les donn√©es sources dans un seul onglet CONSOLIDATION.
          </p>
          <button class="btn btn-primary" onclick="consoliderDonnees()">
            <i class="fas fa-compress-arrows-alt"></i> CONSOLIDER
          </button>
          <div id="consolidation-status" style="margin-top: 16px;"></div>
        </div>
      `)}

      ${createAccordionSection('parcoursA-stats', '3. Statistiques (optionnel)', 'fa-chart-bar', `
        <div class="accordion-body">
          <p style="margin-bottom: 16px; color: #64748b;">
            G√©n√©rez un onglet de statistiques globales (optionnel).
          </p>
          <button class="btn" style="background: #06b6d4; color: white;" onclick="genererStatistiques()">
            <i class="fas fa-chart-line"></i> G√©n√©rer les Statistiques
          </button>
          <div id="stats-status" style="margin-top: 16px;"></div>
        </div>
      `)}

      <div style="margin-top: 32px; display: flex; justify-content: space-between;">
        <button class="btn" onclick="goToPhase(3)" style="background: #e2e8f0; color: #475569;">
          <i class="fas fa-arrow-left"></i> Retour au choix
        </button>
        <button class="btn btn-primary" onclick="goToPhase(5)">
          <i class="fas fa-arrow-right"></i> Suivant : Configuration compl√®te
        </button>
      </div>
    `;

    container.innerHTML = html;
  };

  window.ouvrirOngletsSourcesPourSaisie = function() {
    alert('Vous pouvez maintenant saisir les donn√©es dans les onglets sources. Revenez ici une fois termin√©.');
  };

  window.genererNomPrenomID = function() {
    google.script.run
      .withSuccessHandler(() => {
        alert('‚úÖ ID_ELEVE et NOM_PRENOM g√©n√©r√©s avec succ√®s !');
      })
      .withFailureHandler((err) => {
        alert('‚ùå Erreur : ' + err.message);
      })
      .wizard_genererNomPrenomEtID();
  };

  window.consoliderDonnees = function() {
    google.script.run
      .withSuccessHandler((result) => {
        document.getElementById('consolidation-status').innerHTML = `
          <div style="padding: 12px; background: #d1fae5; color: #065f46; border-radius: 6px;">
            ‚úÖ ${result.message}
          </div>
        `;
      })
      .withFailureHandler((err) => {
        alert('‚ùå Erreur : ' + err.message);
      })
      .wizard_consoliderDonnees();
  };

  window.genererStatistiques = function() {
    google.script.run
      .withSuccessHandler(() => {
        document.getElementById('stats-status').innerHTML = `
          <div style="padding: 12px; background: #d1fae5; color: #065f46; border-radius: 6px;">
            ‚úÖ Statistiques g√©n√©r√©es dans l'onglet STATS
          </div>
        `;
      })
      .withFailureHandler((err) => {
        alert('‚ùå Erreur : ' + err.message);
      })
      .wizard_genererStatistiques();
  };

  // ===================================================================
  // PHASE 5 : CONFIGURATION COMPL√àTE (INLINE)
  // ===================================================================
  window.loadPhase5Content = function() {
    const container = document.getElementById('phase-5-content');

    container.innerHTML = `
      <h2 style="margin-bottom: 24px; color: #1e293b;">
        <i class="fas fa-sliders-h"></i> Configuration Compl√®te
      </h2>
      <p style="margin-bottom: 24px; color: #64748b;">
        Chargement de l'interface de configuration...
      </p>
    `;

    // Charger la configuration depuis le serveur
    google.script.run
      .withSuccessHandler((structureData) => {
        renderConfigurationComplete(container, structureData);
      })
      .withFailureHandler((err) => {
        container.innerHTML += `<div style="color: red;">Erreur : ${err.message}</div>`;
      })
      .chargerStructure();
  };

  // Stocker les donn√©es de configuration dans le wizard state
  window.wizardConfigClasses = [];

  window.renderConfigurationComplete = function(container, structureData) {
    console.log("üìã Rendu de la configuration compl√®te avec:", structureData);

    // Initialiser les classes depuis structureData ou cr√©er une classe par d√©faut
    if (structureData && structureData.classes && structureData.classes.length > 0) {
      window.wizardConfigClasses = structureData.classes;
    } else {
      window.wizardConfigClasses = [{
        origine: '',
        destination: '',
        effectif: 28,
        options: []
      }];
    }

    container.innerHTML = `
      <style>
        .config-classe-item {
          background: white;
          border-radius: 8px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
          padding: 20px;
          margin-bottom: 20px;
        }

        .config-classe-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
          padding-bottom: 10px;
          border-bottom: 2px solid #e2e8f0;
        }

        .config-classe-header h3 {
          margin: 0;
          font-size: 16px;
          font-weight: 600;
          color: #1976d2;
        }

        .config-input-row {
          display: flex;
          align-items: center;
          margin-bottom: 15px;
        }

        .config-input-row label {
          flex: 0 0 180px;
          font-size: 14px;
          font-weight: 500;
        }

        .config-input-row input,
        .config-input-row select {
          flex: 1;
          padding: 8px 12px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
        }

        .config-options-section {
          margin-top: 15px;
          padding: 15px;
          border-radius: 8px;
        }

        .config-options-section h4 {
          font-size: 14px;
          font-weight: 600;
          margin: 0 0 10px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .config-option-item {
          display: flex;
          gap: 10px;
          margin-bottom: 8px;
          align-items: center;
        }

        .config-option-item select {
          flex: 1;
          padding: 8px 12px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
        }

        .config-option-item input {
          width: 80px;
          padding: 8px 12px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
          text-align: center;
        }

        .btn-config-delete {
          background: none;
          border: none;
          color: #e53935;
          cursor: pointer;
          padding: 5px;
          font-size: 20px;
        }

        .btn-config-delete:hover {
          color: #b71c1c;
        }

        .btn-config-add-option {
          width: 100%;
          padding: 10px;
          border: 1px dashed #7b1fa2;
          background: none;
          color: #7b1fa2;
          border-radius: 4px;
          font-size: 13px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 5px;
          cursor: pointer;
          margin-top: 10px;
        }

        .btn-config-add-option:hover {
          background: rgba(123, 31, 162, 0.05);
        }

        .btn-config-add-classe {
          width: 100%;
          padding: 12px;
          border: 1px dashed #1976d2;
          background: none;
          color: #1976d2;
          border-radius: 4px;
          font-size: 14px;
          font-weight: 500;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          cursor: pointer;
          margin: 20px 0;
        }

        .btn-config-add-classe:hover {
          background: rgba(25, 118, 210, 0.05);
        }

        .btn-config-save {
          background: #10b981;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 12px 24px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .btn-config-save:hover {
          background: #059669;
        }
      </style>

      <h2 style="margin-bottom: 24px; color: #1e293b;">
        <i class="fas fa-sliders-h"></i> Configuration Compl√®te
      </h2>

      <div style="padding: 16px; background: #e0f2fe; border-left: 4px solid #0284c7; border-radius: 4px; margin-bottom: 24px;">
        <p style="margin: 0; color: #075985; font-size: 14px;">
          <strong>üìã Instructions :</strong><br>
          Pour chaque classe destination, configurez :
          <ul style="margin: 8px 0 0 0;">
            <li>Classe d'origine et destination</li>
            <li>Effectif cible</li>
            <li>LV2 sp√©cifique (optionnelle) avec quota</li>
            <li>Options compl√©mentaires (LATIN, GREC, etc.) avec quotas</li>
          </ul>
        </p>
      </div>

      <div id="config-classes-container"></div>

      <button class="btn-config-add-classe" onclick="wizardAddClasse()">
        <i class="fas fa-plus"></i> Ajouter une classe
      </button>

      <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
        <button class="btn" onclick="goToPhase(${wizardState.parcours === 'A' ? '4' : '3'})" style="background: #e2e8f0; color: #475569;">
          <i class="fas fa-arrow-left"></i> Retour
        </button>

        <div style="display: flex; gap: 12px;">
          <button class="btn-config-save" onclick="wizardSaveConfiguration()">
            <i class="fas fa-save"></i> Enregistrer la Configuration
          </button>
          <button class="btn btn-primary" onclick="goToPhase(6)">
            <i class="fas fa-arrow-right"></i> Suivant : Lancement LEGACY
          </button>
        </div>
      </div>
    `;

    // Afficher les classes
    wizardRenderClasses();
  };

  // ===================================================================
  // HELPER FUNCTIONS POUR LA CONFIGURATION
  // ===================================================================

  window.wizardRenderClasses = function() {
    const container = document.getElementById('config-classes-container');
    if (!container) return;

    container.innerHTML = '';

    window.wizardConfigClasses.forEach((classe, index) => {
      // S√©parer LV2 et options compl√©mentaires
      let lv2Specifique = null;
      let quotaLV2 = 0;
      let optionsComplementaires = [];

      if (classe.options && classe.options.length > 0) {
        // La premi√®re option est consid√©r√©e comme LV2 potentielle
        if (classe.options[0] && classe.options[0].nom) {
          lv2Specifique = classe.options[0].nom;
          quotaLV2 = classe.options[0].quota || 0;
        }
        // Les autres sont des options compl√©mentaires
        if (classe.options.length > 1) {
          optionsComplementaires = classe.options.slice(1);
        }
      }

      const classeDiv = document.createElement('div');
      classeDiv.className = 'config-classe-item';

      classeDiv.innerHTML = `
        <div class="config-classe-header">
          <h3>Classe #${index + 1} : ${classe.origine || '(√† d√©finir)'} ‚Üí ${classe.destination || '(√† d√©finir)'}</h3>
          <button class="btn-config-delete" onclick="wizardDeleteClasse(${index})" title="Supprimer cette classe">
            <i class="fas fa-trash"></i>
          </button>
        </div>

        <div class="config-input-row">
          <label>Classe d'origine :</label>
          <input type="text" value="${classe.origine || ''}"
                 placeholder="Ex: 6¬∞1"
                 oninput="wizardUpdateClasse(${index}, 'origine', this.value)">
        </div>

        <div class="config-input-row">
          <label>Classe destination :</label>
          <input type="text" value="${classe.destination || ''}"
                 placeholder="Ex: 5¬∞A"
                 oninput="wizardUpdateClasse(${index}, 'destination', this.value)">
        </div>

        <div class="config-input-row">
          <label>Effectif cible :</label>
          <input type="number" value="${classe.effectif || 28}" min="1" max="40"
                 oninput="wizardUpdateClasse(${index}, 'effectif', parseInt(this.value))">
        </div>

        <!-- Section LV2 -->
        <div class="config-options-section" style="background: #e3f2fd;">
          <h4 style="color: #1976d2;">
            <i class="fas fa-language"></i> LV2 Sp√©cifique (optionnelle)
          </h4>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select onchange="wizardUpdateClasseLV2(${index}, this.value)" style="flex: 1;">
              <option value="">Aucune LV2 sp√©cifique</option>
              ${wizardGenerateLV2Options(lv2Specifique)}
            </select>
            <label style="flex: 0 0 60px; font-weight: 500;">Quota :</label>
            <input type="number" value="${quotaLV2}" min="0" max="${classe.effectif || 28}"
                   style="width: 80px; text-align: center;"
                   id="lv2-quota-${index}"
                   oninput="wizardUpdateQuotaLV2(${index}, parseInt(this.value))"
                   ${!lv2Specifique ? 'disabled' : ''}>
          </div>
          <small style="color: #0277bd; font-size: 12px; display: block; margin-top: 8px;">
            <i class="fas fa-info-circle"></i> Cette langue appara√Ætra dans la colonne LV2 pour les √©l√®ves concern√©s
          </small>
        </div>

        <!-- Section Options Compl√©mentaires -->
        <div class="config-options-section" style="background: #f3e5f5;">
          <h4 style="color: #7b1fa2;">
            <i class="fas fa-star"></i> Options Compl√©mentaires
          </h4>
          <div id="config-options-complementaires-${index}">
            ${wizardGenerateOptionsComplementairesHTML(optionsComplementaires, index)}
          </div>
          <button class="btn-config-add-option" onclick="wizardAddOptionComplementaire(${index})">
            <i class="fas fa-plus"></i> Ajouter une option compl√©mentaire
          </button>
          <small style="color: #6a1b9a; font-size: 12px; display: block; margin-top: 8px;">
            <i class="fas fa-info-circle"></i> Ces options appara√Ætront dans la colonne OPT pour les √©l√®ves concern√©s
          </small>
        </div>
      `;

      container.appendChild(classeDiv);
    });
  };

  window.wizardGenerateLV2Options = function(lv2Selectionnee) {
    const lv2List = wizardState.data.lv2List || [];
    let html = '';

    lv2List.forEach(lv2 => {
      html += `<option value="${lv2}" ${lv2 === lv2Selectionnee ? 'selected' : ''}>${lv2}</option>`;
    });

    return html;
  };

  window.wizardGenerateOptionsComplementairesHTML = function(optionsComplementaires, classeIndex) {
    if (!optionsComplementaires || optionsComplementaires.length === 0) {
      return '<p style="color: #666; font-style: italic; margin: 8px 0;">Aucune option compl√©mentaire</p>';
    }

    let html = '';
    optionsComplementaires.forEach((option, optIndex) => {
      html += `
        <div class="config-option-item">
          <select onchange="wizardUpdateOptionComplementaire(${classeIndex}, ${optIndex}, 'nom', this.value)" style="flex: 1;">
            <option value="">-- Choisir --</option>
            ${wizardGenerateOptionsComplementairesSelectHTML(option.nom)}
          </select>
          <label style="flex: 0 0 60px; text-align: center; font-size: 12px; color: #666;">Quota</label>
          <input type="number" value="${option.quota || 0}" min="0" max="35"
                 style="width: 80px; text-align: center;"
                 oninput="wizardUpdateOptionComplementaire(${classeIndex}, ${optIndex}, 'quota', parseInt(this.value))">
          <button class="btn-config-delete" onclick="wizardDeleteOptionComplementaire(${classeIndex}, ${optIndex})" title="Supprimer">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
    });

    return html;
  };

  window.wizardGenerateOptionsComplementairesSelectHTML = function(optionSelectionnee) {
    const optionsList = wizardState.data.optionsList || [];
    let html = '';

    optionsList.forEach(option => {
      html += `<option value="${option}" ${option === optionSelectionnee ? 'selected' : ''}>${option}</option>`;
    });

    return html;
  };

  // ===================================================================
  // FONCTIONS DE GESTION DES CLASSES ET OPTIONS
  // ===================================================================

  window.wizardUpdateClasse = function(index, propriete, valeur) {
    if (window.wizardConfigClasses[index]) {
      window.wizardConfigClasses[index][propriete] = valeur;
      // Rafra√Æchir l'affichage pour mettre √† jour le titre
      wizardRenderClasses();
    }
  };

  window.wizardUpdateClasseLV2 = function(classeIndex, lv2Value) {
    const quotaInput = document.getElementById(`lv2-quota-${classeIndex}`);
    if (quotaInput) {
      quotaInput.disabled = !lv2Value;
      if (!lv2Value) quotaInput.value = 0;
    }
    console.log(`Classe ${classeIndex}: LV2 = ${lv2Value}`);
  };

  window.wizardUpdateQuotaLV2 = function(classeIndex, quota) {
    console.log(`Classe ${classeIndex}: Quota LV2 = ${quota}`);
  };

  window.wizardAddClasse = function() {
    window.wizardConfigClasses.push({
      origine: '',
      destination: '',
      effectif: 28,
      options: []
    });
    wizardRenderClasses();
  };

  window.wizardDeleteClasse = function(index) {
    if (confirm('Voulez-vous vraiment supprimer cette classe ?')) {
      window.wizardConfigClasses.splice(index, 1);
      wizardRenderClasses();
    }
  };

  window.wizardAddOptionComplementaire = function(classeIndex) {
    if (!wizardState.data.optionsList || wizardState.data.optionsList.length === 0) {
      alert('Aucune option disponible !\n\nVous devez d\'abord configurer les options dans la Phase 2.');
      return;
    }

    const classe = window.wizardConfigClasses[classeIndex];
    if (!classe) return;

    // Initialiser options si n√©cessaire
    if (!classe.options) classe.options = [];

    // Ajouter une nouvelle option (en position 2+, car position 1 = LV2)
    classe.options.push({
      nom: '',
      quota: 0
    });

    wizardRenderClasses();
  };

  window.wizardUpdateOptionComplementaire = function(classeIndex, optIndex, propriete, valeur) {
    const classe = window.wizardConfigClasses[classeIndex];
    if (!classe || !classe.options) return;

    // optIndex correspond aux options compl√©mentaires (index 1+)
    const realIndex = optIndex + 1; // +1 car index 0 = LV2

    if (classe.options[realIndex]) {
      classe.options[realIndex][propriete] = valeur;
    }

    console.log(`Classe ${classeIndex}, Option compl√©mentaire ${optIndex}: ${propriete} = ${valeur}`);
  };

  window.wizardDeleteOptionComplementaire = function(classeIndex, optIndex) {
    const classe = window.wizardConfigClasses[classeIndex];
    if (!classe || !classe.options) return;

    const realIndex = optIndex + 1; // +1 car index 0 = LV2

    if (classe.options[realIndex]) {
      classe.options.splice(realIndex, 1);
      wizardRenderClasses();
    }
  };

  // ===================================================================
  // FONCTION DE SAUVEGARDE
  // ===================================================================

  window.wizardSaveConfiguration = function() {
    console.log("üíæ Sauvegarde de la configuration...");

    // Collecter les donn√©es depuis l'interface
    const classesAvecOptions = [];

    window.wizardConfigClasses.forEach((classe, index) => {
      const classeData = {
        origine: classe.origine,
        destination: classe.destination,
        effectif: classe.effectif,
        options: []
      };

      // 1. R√©cup√©rer la LV2 depuis l'interface
      const lv2Select = document.querySelector(`[onchange*="wizardUpdateClasseLV2(${index}"]`);
      const quotaLV2Input = document.getElementById(`lv2-quota-${index}`);

      if (lv2Select && lv2Select.value && quotaLV2Input && parseInt(quotaLV2Input.value) > 0) {
        classeData.options.push({
          nom: lv2Select.value,
          quota: parseInt(quotaLV2Input.value)
        });
      }

      // 2. R√©cup√©rer les options compl√©mentaires depuis l'interface
      const optionsContainer = document.getElementById(`config-options-complementaires-${index}`);
      if (optionsContainer) {
        const selects = optionsContainer.querySelectorAll('select');
        const inputs = optionsContainer.querySelectorAll('input[type="number"]');

        for (let i = 0; i < selects.length; i++) {
          if (selects[i] && selects[i].value && inputs[i] && parseInt(inputs[i].value) > 0) {
            classeData.options.push({
              nom: selects[i].value,
              quota: parseInt(inputs[i].value)
            });
          }
        }
      }

      classesAvecOptions.push(classeData);
    });

    // Pr√©parer les donn√©es pour la sauvegarde
    const structureData = {
      classes: classesAvecOptions,
      options: wizardState.data.optionsList || []
    };

    console.log("üì§ Donn√©es √† sauvegarder:", structureData);

    // Sauvegarder via le backend
    google.script.run
      .withSuccessHandler((result) => {
        console.log("‚úÖ Sauvegarde r√©ussie:", result);
        alert(result.message || 'Configuration sauvegard√©e avec succ√®s dans l\'onglet _STRUCTURE !');
      })
      .withFailureHandler((error) => {
        console.error("‚ùå Erreur sauvegarde:", error);
        alert('Erreur lors de la sauvegarde : ' + error);
      })
      .sauvegarderStructure(structureData);
  };

  // ===================================================================
  // PHASE 6 : LANCEMENT LEGACY
  // ===================================================================
  window.loadPhase6Content = function() {
    const container = document.getElementById('phase-6-content');

    container.innerHTML = `
      <h2 style="margin-bottom: 24px; color: #1e293b;">
        <i class="fas fa-rocket"></i> Lancement du Processus LEGACY
      </h2>

      <div style="padding: 24px; background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px; margin-bottom: 24px;">
        <h3 style="color: #065f46; margin-bottom: 12px;">Pr√™t √† lancer !</h3>
        <p style="color: #065f46; margin: 0;">
          Toutes les √©tapes sont compl√©t√©es. Vous pouvez maintenant lancer le pipeline de r√©partition LEGACY.
        </p>
      </div>

      <button class="btn btn-primary" onclick="lancerLEGACY()" style="font-size: 16px; padding: 16px 32px;">
        <i class="fas fa-play"></i> LANCER LE PROCESSUS LEGACY
      </button>

      <div id="legacy-status" style="margin-top: 24px;"></div>

      <div style="margin-top: 32px; text-align: left;">
        <button class="btn" onclick="goToPhase(5)" style="background: #e2e8f0; color: #475569;">
          <i class="fas fa-arrow-left"></i> Retour
        </button>
      </div>
    `;
  };

  window.lancerLEGACY = function() {
    if (!confirm('√ätes-vous s√ªr de vouloir lancer le processus LEGACY ?')) {
      return;
    }

    document.getElementById('legacy-status').innerHTML = `
      <div style="padding: 12px; background: #dbeafe; color: #1e40af; border-radius: 6px;">
        ‚è≥ Lancement en cours...
      </div>
    `;

    google.script.run
      .withSuccessHandler((result) => {
        document.getElementById('legacy-status').innerHTML = `
          <div style="padding: 12px; background: #d1fae5; color: #065f46; border-radius: 6px;">
            ‚úÖ ${result.message}
          </div>
        `;
      })
      .withFailureHandler((err) => {
        document.getElementById('legacy-status').innerHTML = `
          <div style="padding: 12px; background: #fee2e2; color: #991b1b; border-radius: 6px;">
            ‚ùå Erreur : ${err.message}
          </div>
        `;
      })
      .legacy_runFullPipeline_PRIME();
  };

  // ===================================================================
  // NAVIGATION
  // ===================================================================
  window.goToPhase = function(phaseNum) {
    // Masquer toutes les phases
    document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));

    // Afficher la phase demand√©e
    const phaseEl = document.getElementById(`phase-${phaseNum}-content`);
    if (phaseEl) {
      phaseEl.classList.add('active');
    }

    // Charger le contenu si besoin
    loadPhaseContent(phaseNum);

    // Mettre √† jour la navigation (si elle existe)
    updateNavigation(phaseNum);

    wizardState.currentStep = phaseNum;
  };

  window.loadPhaseContent = function(phaseNum) {
    const loaders = {
      1: loadPhase1Content,
      2: loadPhase2Content,
      3: loadPhase3Content,
      4: loadPhase4Content,
      5: loadPhase5Content,
      6: loadPhase6Content
    };

    if (loaders[phaseNum]) {
      loaders[phaseNum]();
    }
  };

  window.updateNavigation = function(phaseNum) {
    // Mettre √† jour les badges de navigation (si ils existent)
    document.querySelectorAll('.nav-item').forEach((item, index) => {
      if (index + 1 === phaseNum) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
  };

  // ===================================================================
  // INIT
  // ===================================================================
  document.addEventListener('DOMContentLoaded', function() {
    loadPhase1Content();
  });

})();
</script>
